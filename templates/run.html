<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Session {{ run_id }}</title>
  <style>
    body { font-family: Arial, sans-serif; background:#0f172a; color:#e2e8f0; margin:0; padding:0;}
    header { padding:20px; background:linear-gradient(120deg,#0ea5e9,#1e293b); }
    main { max-width:1100px; margin:20px auto; padding:20px; }
    section { background:#111827; border-radius:16px; padding:18px; margin-bottom:18px; box-shadow:0 12px 30px rgba(0,0,0,0.35);} 
    h2 { margin:0 0 8px 0; }
    .pair { display:flex; gap:12px; flex-wrap:wrap; }
    .pair img { width:220px; border-radius:12px; object-fit:cover; border:1px solid #1f2937;}
    form { margin-top:12px; display:flex; gap:12px; align-items:center; flex-wrap:wrap;}
    input, select { padding:10px; border-radius:10px; border:1px solid #334155; background:#0b1221; color:#e2e8f0;}
    button { padding:12px 16px; border:none; border-radius:10px; background:#0ea5e9; color:#0b1221; font-weight:800; cursor:pointer;}
    button:hover { background:#38bdf8;}
    .flash { background:#7c3aed; padding:10px; border-radius:10px; margin-bottom:10px;}
    .rail { display:flex; gap:10px; overflow-x:auto; padding-bottom:8px;}
    .rail img { height:220px; border-radius:10px; border:1px solid #1f2937; flex:0 0 auto;}
    .rail::-webkit-scrollbar { height:8px; }
    .rail::-webkit-scrollbar-thumb { background:#0ea5e9; border-radius:999px;}
    .note { color:#94a3b8; font-size:0.95rem;}
    .player { display:flex; flex-direction:column; gap:12px; }
    .frame-box { background:#0b1221; border-radius:14px; padding:10px; border:1px solid #1f2937; box-shadow:0 12px 30px rgba(0,0,0,0.35); max-width:960px; }
    .player img { width:100%; height:480px; object-fit:contain; border-radius:10px; display:block; }
    .slider-row { display:flex; align-items:center; gap:12px; }
    input[type=range] { flex:1; accent-color:#0ea5e9; }
    #map { width:100%; height:320px; min-height:320px; border-radius:14px; border:1px solid #1f2937; margin-top:12px; box-shadow:0 10px 26px rgba(0,0,0,0.3); background:radial-gradient(circle at 25% 25%, #0f172a 0, #0b1221 60%); overflow:hidden; }
    .map-hint { font-size:0.95rem; color:#cbd5e1; margin-top:8px; }
    .loading-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.55); display:flex; align-items:center; justify-content:center; z-index:999; opacity:0; pointer-events:none; transition:opacity 0.2s ease; }
    .loading-overlay.active { opacity:1; pointer-events:auto; }
    .spinner { width:74px; height:74px; border-radius:50%; border:8px solid #1f2937; border-top-color:#0ea5e9; animation:spin 0.9s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg);} }
    .loading-text { margin-top:12px; font-weight:700; color:#e2e8f0; text-align:center; }
    .selector-row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin:10px 0; }
  </style>
  <link rel="stylesheet" href="{{ url_for('static', filename='leaflet/leaflet.css') }}">
</head>
<body>
  <div class="loading-overlay" id="loading-overlay">
    <div style="display:flex; flex-direction:column; align-items:center;">
      <div class="spinner" role="status" aria-label="Chargement en cours"></div>
      <div class="loading-text">Traitement en cours…</div>
    </div>
  </div>
  <header>
    <h1>Street View Interpolation</h1>
    <p>Une seule page : saisissez l'adresse et la clé, choisissez le sens, interpoler, puis scrollez.</p>
  </header>
  <main>
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        {% for msg in messages %}
          <div class="flash">{{ msg }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <section>
      <h2>Adresse et clé</h2>
      <form action="{{ url_for('index') }}" method="post" id="generate-form">
        <div style="margin-bottom:12px;">
          <label for="address">Adresse</label>
          <input id="address" name="address" placeholder="12 rue Exemple, Paris" value="{{ address or '' }}" required>
        </div>
        <div style="margin-bottom:12px;">
          <label for="api_key">Clé API Google Street View</label>
          <input id="api_key" name="api_key" placeholder="GOOGLE_API_KEY" value="{{ default_key }}">
        </div>
        <div style="margin-bottom:12px;">
          <label for="num_sources">Nombre de photos Street View à récupérer</label>
          <input id="num_sources" name="num_sources" type="number" min="2" max="12" value="{{ num_sources or 4 }}">
        </div>
        <button type="submit">Générer les vues officielles</button>
      </form>
      <div id="map"></div>
      <div class="map-hint">Double-cliquez sur une rue à Île-de-France pour remplir automatiquement le champ adresse.</div>
    </section>

    <section>
      <h2>1. Vues consécutives</h2>
      <p class="note">Plusieurs captures sont prises dans chaque sens. Choisissez la séquence à interpoler.</p>
      {% if forward and backward %}
        <div class="pair">
          <div>
            <p>Avant ({{ forward|length }} photos)</p>
            {% for img in forward %}
              <img src="{{ img }}" alt="forward {{ loop.index }}">
            {% endfor %}
          </div>
          <div>
            <p>Arrière ({{ backward|length }} photos)</p>
            {% for img in backward %}
              <img src="{{ img }}" alt="backward {{ loop.index }}">
            {% endfor %}
          </div>
        </div>
        <form action="{{ url_for('run_interpolation') }}" method="post" id="interpolation-form">
          <input type="hidden" name="run_id" value="{{ run_id }}">
          <label for="direction">Sens :</label>
          <select id="direction" name="direction">
            <option value="forward">Avant (ordre des captures)</option>
            <option value="backward">Arrière (sens opposé)</option>
          </select>
          <label for="frames_per_official">Frames par intervalle (par photo Street View)</label>
          <input id="frames_per_official" name="frames_per_official" type="number" min="2" max="120" value="30">
          <button type="submit">Interpoler</button>
        </form>
      {% else %}
        <p class="note">Aucune session active. Générer une adresse pour voir les vues.</p>
      {% endif %}
    </section>

    <section>
      <h2>2. Galerie défilable</h2>
      <p class="note">Choisissez le dossier a afficher si plusieurs sessions existent.</p>
      {% if available_runs %}
        <form method="get" class="selector-row" id="gallery-form">
          <label for="run_id">Dossier a afficher</label>
          <select name="run_id" id="run_id">
            <option value="">-- choisir un dossier --</option>
            {% for folder in available_runs %}
              <option value="{{ folder }}" {% if folder == run_id %}selected{% endif %}>{{ folder }}</option>
            {% endfor %}
          </select>
          <button type="submit">Afficher</button>
        </form>
      {% else %}
        <p class="note">Aucun dossier trouve dans le repertoire de sortie.</p>
      {% endif %}
      <p class="note">Utilisez le curseur pour parcourir les frames une par une.</p>
      {% if frames_forward %}
        <div class="player" id="player-forward" data-label="Avant">
          <h3>Sens avant</h3>
          <div class="frame-box">
            <img id="img-forward" src="{{ frames_forward[0] }}" alt="Frame avant">
          </div>
          <div class="slider-row">
            <span id="count-forward">0 / {{ frames_forward|length - 1 }}</span>
            <input type="range" id="range-forward" min="0" max="{{ frames_forward|length - 1 }}" value="0" step="1">
          </div>
        </div>
      {% endif %}
      {% if frames_backward %}
        <div class="player" id="player-backward" data-label="Arrière">
          <h3>Sens arrière</h3>
          <div class="frame-box">
            <img id="img-backward" src="{{ frames_backward[0] }}" alt="Frame arrière">
          </div>
          <div class="slider-row">
            <span id="count-backward">0 / {{ frames_backward|length - 1 }}</span>
            <input type="range" id="range-backward" min="0" max="{{ frames_backward|length - 1 }}" value="0" step="1">
          </div>
        </div>
      {% endif %}
      {% if not frames_forward and not frames_backward %}
        <p class="note">Aucune frame encore générée.</p>
      {% endif %}
    </section>
  </main>
  <script>
    const players = [
      { list: {{ frames_forward|tojson|safe }}, imgId: 'img-forward', rangeId: 'range-forward', countId: 'count-forward' },
      { list: {{ frames_backward|tojson|safe }}, imgId: 'img-backward', rangeId: 'range-backward', countId: 'count-backward' },
    ];
    players.forEach(p => {
      if (!p.list || !p.list.length) return;
      const img = document.getElementById(p.imgId);
      const range = document.getElementById(p.rangeId);
      const count = document.getElementById(p.countId);
      if (!img || !range || !count) return;
      range.addEventListener('input', () => {
        const idx = parseInt(range.value, 10);
        img.src = p.list[idx];
        count.textContent = `${idx} / ${p.list.length - 1}`;
      });
    });
  </script>
  <script src="{{ url_for('static', filename='leaflet/leaflet.js') }}"></script>
  <script>
    const mapContainer = document.getElementById('map');
    if (!window.L || !mapContainer) {
      if (mapContainer) {
        mapContainer.innerHTML = "<p style='padding:16px; color:#e2e8f0;'>Carte indisponible (Leaflet non chargé). Vérifiez votre connexion.</p>";
      }
    } else {
      const map = L.map('map', { doubleClickZoom: false }).setView([48.8566, 2.3522], 11);
      const bounds = L.latLngBounds([48.0, 1.5], [49.3, 3.7]);
      map.setMaxBounds(bounds);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap',
        maxZoom: 19,
      }).addTo(map);

      let marker;
      const addressInput = document.getElementById('address');

      async function reverseGeocode(lat, lng) {
        const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`;
        const resp = await fetch(url, { headers: { 'Accept-Language': 'fr' } });
        if (!resp.ok) throw new Error('Reverse geocoding échoué');
        const data = await resp.json();
        if (data && data.display_name) return data.display_name;
        return `Lat ${lat.toFixed(5)}, Lng ${lng.toFixed(5)}`;
      }

      map.on('dblclick', async (e) => {
        const { lat, lng } = e.latlng;
        if (marker) {
          marker.setLatLng(e.latlng);
        } else {
          marker = L.marker(e.latlng).addTo(map);
        }
        try {
          addressInput.value = 'Recherche de la rue...';
          const addr = await reverseGeocode(lat, lng);
          addressInput.value = addr;
        } catch (err) {
          addressInput.value = `Lat ${lat.toFixed(5)}, Lng ${lng.toFixed(5)}`;
        }
      });
    }

    const overlay = document.getElementById('loading-overlay');
    function attachLoader(formId) {
      const form = document.getElementById(formId);
      if (!form) return;
      form.addEventListener('submit', () => {
        overlay.classList.add('active');
      });
    }
    attachLoader('generate-form');
    attachLoader('interpolation-form');
  </script>
</body>
</html>
